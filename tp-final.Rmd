---
title: "Trabajo Final - Estadistica Espacial"
output: html_notebook
---

Instalamos los paquetes necesarios
```{r}
library(dplyr)
library(sf)
```

Cargamos los datasets
```{r}
estaciones <- read.csv("data_smn/preprocessed/estaciones_smn_v2.csv")
horarios <- read.csv("data_smn/preprocessed/datohorario20210420.csv")
```

Observamos como esta compuesto el dataset
```{r}
glimpse(estaciones)
```

```{r}
glimpse(horarios)
```
Observamos que la variable que representa la velocidad del viento en km/h es de tipo Char, por lo cual debemos convertila en int.
```{r}
horarios$FF <- as.numeric(horarios$FF)
```


```{r}
summary(estaciones$ALTURA)
summary(horarios$HORA)
summary(horarios$TEMP)
summary(horarios$HUM)
summary(horarios$PNM)
summary(horarios$DD)
summary(horarios$FF)
```
```{r}
hist(estaciones$ALTURA, main = "Histograma de la altura", xlab = "Altura")
hist(horarios$HORA, main = "Histograma de horarios", xlab = "Horarios")
hist(horarios$TEMP, main = "Histograma de temperatura", xlab = "Temperatura")
hist(horarios$HUM, main = "Histograma de humedad", xlab = "Humedad")
hist(horarios$PNM, main = "Histograma de presion atmosferica", xlab = "Presion Atmosferica")
hist(horarios$DD, main = "Histograma de la direccion del viento", xlab = "Direccion del viento")
hist(horarios$FF, main = "Histograma de la velocidad del viento", xlab = "Velocidad del viento")
```
Creamos unos boxplot para visualizar la distribucionde datos que potencialmente nos interecen para proceder con el analisis
```{r}
boxplot(estaciones$ALTURA, main = "Boxplot de la altura", xlab = "Altura")
boxplot(horarios$HORA, main = "Boxplot de horarios", xlab = "Horarios")
boxplot(horarios$TEMP, main = "Boxplot de temperatura", xlab = "Temperatura")
boxplot(horarios$HUM, main = "Boxplot de humedad", xlab = "Humedad")
boxplot(horarios$PNM, main = "Boxplot de presion atmosferica", xlab = "Presion Atmosferica")
boxplot(horarios$DD, main = "Boxplot de la direccion del viento", xlab = "Direccion del viento")
boxplot(horarios$FF, main = "Boxplot de la velocidad del viento", xlab = "Velocidad del viento")
```

```{r}
library(DataExplorer)
plot_boxplot(horarios, by = "HORA")
plot_boxplot(horarios, by = "TEMP")
```
Ahora, veamos que tan correlacionadas estan estas variables
```{r}
library(ggcorrplot)

corr <- cor(horarios[, c(2,3,4,5,6,7)], use = "complete.obs")
ggcorrplot(corr, type = "lower", outline.col = "black",
 lab=TRUE,
 ggtheme = ggplot2::theme_gray,
 colors = c("#6D9EC1", "white", "#E46726"))
```
Como correlacionan estas variables con la altura?

Hay datos nulos en estos datasets?
```{r}
print("Nulos en horarios")
which(is.na(horarios))
```

```{r}
print("Nulos en estaciones")
which(is.na(estaciones))
```
Borramos los nulos del dataset
```{r}
estaciones = na.omit(estaciones)
horarios = na.omit(horarios)
```

```{r}
# Analisis de simetria
library(psych)
skew(horarios$FF)

kurtosi(horarios$FF)
```


Necesitamos convertir las latitudes y longitudes a
```{r}
library(biogeo)

latitud <- c()
longitud <- c()

for(i in 1:nrow(estaciones)) {
     latitud[i] <- dms2dd(dd = estaciones[i, "LATITUD_GRADOS"], mm = estaciones[i, "LATITUD_MINUTOS"], ss = 0, ns = "S")
     longitud[i] <- dms2dd(dd = estaciones[i, "LONGITUD_GRADOS"], mm = estaciones[i, "LONGITUD_MINUTOS"], ss = 0, ns = "S")
}

estaciones['LATITUD'] <- latitud
estaciones['LONGITUD'] <- longitud

```


Unimos las dos tablas usando la variable NOMBRE como punto para combinar los datasets
```{r}
data <- full_join(estaciones, horarios, by = c("NOMBRE" = "NOMBRE"))

glimpse(data)
```
Eliminamos las observaciones nulas en el dataset
```{r}
data = na.omit(data)
```

```{r}
corr <- cor(data[, c(7,13,14,15,16,17,18)], use = "complete.obs")
ggcorrplot(corr, type = "lower", outline.col = "black",
 lab=TRUE,
 ggtheme = ggplot2::theme_gray,
 colors = c("#6D9EC1", "white", "#E46726"))
```


Agregamos los datos por nombre calculando el promedio y desvio del viento
```{r}
data_agg = data %>%
  group_by(NOMBRE) %>%
  summarise(MEAN_VIENTO_KMH = mean(FF), SD_VIENTO_KMH = sd(FF), LONGITUD = unique(LONGITUD), LATITUD = unique(LATITUD), .groups = "keep")
```

Dibujamos en el mapa de argentina los puntos que tenemos en el dataset agrupado. Para eso
cargamos el dataset de departamentos que tiene info de toda la argentina
```{r}
library(ggplot2)
departamentos <- st_read("data_departamentos/Codgeo_Pais_x_dpto_con_datos/pxdptodatosok.shp")

#verificamos la proyeccion de departamentos
st_crs(departamentos)

#como tiene otra proyeccion la pasamos a mercator
departamentos <- st_transform(departamentos, crs = 4326)

#ggplot() +
#  geom_sf(data = departamentos) +
#  geom_point(data = data_agg, aes(x = x, y = y), colour = "red", size = 1) +
#  theme_minimal() +
#  ggsave('plot.png',height = 25 , width = 30)
```

Convertimos data_agg a data.frame
```{r}
df_data_agg = data.frame(data_agg)
```

Transformamos df_data_agg en un archivo geográfico utilizando el código de proyección mercator
```{r}
data_sf = st_as_sf(df_data_agg, coords = c("LONGITUD", "LATITUD"), crs = 4326)
```

Validamos la clase del nuevo dataframe
```{r}
class(data_sf)
```
##TODO: graficar el mapa de densidades con los puntos de las estaciones en data.

## GRAFICO INTERACTIVO ##
```{r}
library(leaflet)

leaflet() %>%
  addTiles() %>%
  addCircles(data = data_sf, weight = 3)

```
# Analisis Estadistico de los datos

Analisis univariado
```{r}
describe(data_agg$MEAN_VIENTO_KMH)
```


```{r}
hist(data_agg$MEAN_VIENTO_KMH)
boxplot(data_agg$MEAN_VIENTO_KMH)
```
```{r}
hist(data_agg$SD_VIENTO_KMH)
boxplot(data_agg$SD_VIENTO_KMH)
```
# Analisis descriptivo de normalidad de los datos
```{r}
hist(data_agg$MEAN_VIENTO_KMH)
boxplot(data_agg$MEAN_VIENTO_KMH)
```
```{r}
qqnorm(data_agg$MEAN_VIENTO_KMH)
qqline(data_agg$MEAN_VIENTO_KMH, col=2)
```
hacemos el test de normalidad
```{r}
shapiro.test(data_agg$MEAN_VIENTO_KMH)
```
El p-value obtenido es menor a 0.05, lo cual indica que los datos que tenemos no son normales



```{r}
coordinates(data_agg) = ~LATITUD+LONGITUD
class(data_agg)
```
```{r}
plot(data_agg)
```
```{r}
v <- variogram(MEAN_VIENTO_KMH~1, data_agg)
plot(v)
```
```{r}
vt_exp = fit.variogram(v, vgm(125, "Exp", 30, 5))
vt_exp
plot(v , vt_exp)
```
```{r}
vt_mat = fit.variogram(v, vgm(125, "Mat", 30, 5))
plot(v , vt_sph)
```
```{r}
vt_exc = fit.variogram(v, vgm(125, "Exc", 30, 5))
plot(v , vt_sph)
```

```{r}
attr(vt_exp, 'SSErr')
attr(vt_mat, 'SSErr')
attr(vt_exc, 'SSErr')
```

