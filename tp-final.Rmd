---
title: "Trabajo Final - Estadistica Espacial"
output: html_notebook
---

Instalamos los paquetes necesarios
```{r}
library(dplyr)
library(sf)
```


```{r}
estaciones <- read.csv("data_smn/preprocessed/estaciones_smn_v2.csv")
horarios <- read.csv("data_smn/preprocessed/datohorario20210420.csv")
```

```{r}
glimpse(estaciones)
```

```{r}
glimpse(horarios)
```

Hay datos nulos en estos datasets?
```{r}
print("Nulos en horarios")
which(is.na(horarios))
```

```{r}
print("Nulos en estaciones")
which(is.na(estaciones))
```
Borramos los nulos del dataset
```{r}
estaciones = na.omit(estaciones)
horarios = na.omit(horarios)
```
Necesitamos convertir las latitudes y longitudes a
```{r}
library(biogeo)

latitud <- c()
longitud <- c()

for(i in 1:nrow(estaciones)) {
     latitud[i] <- dms2dd(dd = estaciones[i, "LATITUD_GRADOS"], mm = estaciones[i, "LATITUD_MINUTOS"], ss = 0, ns = "S")
     longitud[i] <- dms2dd(dd = estaciones[i, "LONGITUD_GRADOS"], mm = estaciones[i, "LONGITUD_MINUTOS"], ss = 0, ns = "S")
}

estaciones['LATITUD'] <- latitud
estaciones['LONGITUD'] <- longitud

```


Unimos las dos tablas usando la variable NOMBRE como punto para combinar los datasets
```{r}
data <- full_join(estaciones, horarios, by = c("NOMBRE" = "NOMBRE"))

glimpse(data)
```
Eliminamos las observaciones nulas en el dataset
```{r}
data = na.omit(data)
```

La variable que representa los vientos en km/h es de tipo char. La convertimos en numeric
```{r}
data$FF = as.numeric(data$FF)
```

Agregamos los datos por nombre calculando el promedio y desvio del viento
```{r}
data_agg = data %>%
  group_by(NOMBRE) %>%
  summarise(MEAN_VIENTO_KMH = mean(FF), SD_VIENTO_KMH = sd(FF), LONGITUD = unique(LONGITUD), LATITUD = unique(LATITUD), .groups = "keep")
```

Dibujamos en el mapa de argentina los puntos que tenemos en el dataset agrupado. Para eso
cargamos el dataset de departamentos que tiene info de toda la argentina
```{r}
library(ggplot2)
departamentos <- st_read("data_departamentos/Codgeo_Pais_x_dpto_con_datos/pxdptodatosok.shp")

#verificamos la proyeccion de departamentos
st_crs(departamentos)

#como tiene otra proyeccion la pasamos a mercator
departamentos <- st_transform(departamentos, crs = 4326)

#ggplot() +
#  geom_sf(data = departamentos) +
#  geom_point(data = data_agg, aes(x = x, y = y), colour = "red", size = 1) +
#  theme_minimal() +
#  ggsave('plot.png',height = 25 , width = 30)
```

Convertimos data_agg a data.frame
```{r}
df_data_agg = data.frame(data_agg)
```

Transformamos df_data_agg en un archivo geográfico utilizando el código de proyección mercator
```{r}
data_sf = st_as_sf(df_data_agg, coords = c("LONGITUD", "LATITUD"), crs = 4326)
```

Validamos la clase del nuevo dataframe
```{r}
class(data_sf)
```

## GRAFICO INTERACTIVO ##
```{r}
library(leaflet)

leaflet() %>%
  addTiles() %>%
  addCircles(data = data_sf, weight = 2)

```

# Analisis descriptivo de normalidad de los datos
```{r}
hist(data_agg$MEAN_VIENTO_KMH)
boxplot(data_agg$MEAN_VIENTO_KMH)
```
```{r}
qqnorm(data_agg$MEAN_VIENTO_KMH)
qqline(data_agg$MEAN_VIENTO_KMH, col=2)
```
hacemos el test de normalidad
```{r}
shapiro.test(data_agg$MEAN_VIENTO_KMH)
```
El p-value obtenido es menor a 0.05, lo cual indica que los datos que tenemos no son normales
